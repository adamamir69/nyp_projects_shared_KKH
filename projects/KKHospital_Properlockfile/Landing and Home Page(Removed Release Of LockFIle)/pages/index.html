<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home - KKH</title>
  <link rel="stylesheet" href="/index.css">
  <style>
    /* minimal modal styles so popup is visible; remove if you already have them */
    .modal { display: none; position: fixed; inset: 0; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); z-index: 100; }
    .modal .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 320px; }
    .action-btn { margin: 6px; }

    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .loading-overlay.show {
      display: flex;
      flex-direction: column;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      color: #fff;
      margin-top: 15px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-text">Processing...</div>
</div>

<header class="topbar">
  <div class="container">
    <h2>KK Hospital</h2>
    <div class="account-info">
      <span id="username-display">Logged in as: <span id="user"></span></span>
      <a href="/logout" class="logout-btn" id="logout-btn">Logout</a>
    </div>
  </div>
</header>

<main class="main-content">
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="schedule">Work Schedule</button>
    <button class="tab-btn" data-tab="create-user">Create Users</button>
    <button class="tab-btn" data-tab="view-users">View Users</button>
  </div>

  <!-- Schedule Tab -->
        <div id="tab-schedule" class="tab-section">
            <h1>Work Schedule</h1>
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th>Ward</th>
                        <th>Nurse In-Charge</th>
                        <th>Patients Assigned</th>
                        <th>Workload Quota</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Ward 3A</td>
                        <td>Nur Aisyah</td>
                        <td>
                            • Patient 001 Sarah Lim<br>
                            • Patient 014 Megan Tan
                        </td>
                        <td>2 / 5</td>
                    </tr>
                    <tr>
                        <td>Ward 4B</td>
                        <td>John Lee</td>
                        <td>
                            • Patient 007 Ahmad Rahim<br>
                            • Patient 021 Chloe Ng<br>
                            • Patient 030 Lucas Wong
                        </td>
                        <td>3 / 5</td>
                    </tr>
                    <tr>
                        <td>Ward 2C</td>
                        <td>Lim Jia Wen</td>
                        <td>
                            • Patient 012 Tan Wei<br>
                            • Patient 088 Siti Nur<br>
                        </td>
                        <td>2 / 5</td>
                    </tr>
                </tbody>
            </table>
        </div>

  <div id="tab-create-user" class="tab-section" style="display:none;">
    <h1>Create User</h1>
    <form class="create-user-form">
      <div class="input-group"><label>Username</label><input id="new-username" required></div>
      <div class="input-group"><label>Password</label><input id="new-password" type="password" required></div>
      <div class="input-group">
        <label>Role</label>
        <select id="user-role" required>
          <option value="" disabled selected>Select role</option>
          <option>Administrator</option>
          <option>User</option>
        </select>
      </div>
      <button type="submit" class="action-btn">Create User</button>
    </form>
  </div>

  <div id="tab-view-users" class="tab-section" style="display:none;">
    <h1>All Users</h1>
    <table class="users-table">
      <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
      <tbody id="users-list"></tbody>
    </table>
  </div>

  <!-- Update Modal -->
  <div id="update-user-modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3>Update User</h3>

    <form id="update-user-form">
      <div class="input-group">
        <label for="update-username">Username</label>
        <input type="text" id="update-username" readonly>
      </div>

      <div class="input-group">
        <label for="update-role">Role</label>
        <select id="update-role">
          <option>Administrator</option>
          <option>User</option>
        </select>
      </div>

      <div class="modal-buttons">
        <button type="submit" class="btn-save">Save</button>
        <button type="button" id="cancel-update" class="btn-cancel">Cancel</button>
      </div>
    </form>
  </div>
</div>

</main>

<script>
  // small helper
  function showPopup(msg, type = "info") {
    console.log("[popup]", type, msg);
    const d = document.createElement("div");
    d.textContent = msg;
    d.style.position = "fixed";
    d.style.bottom = "16px";
    d.style.right = "16px";
    d.style.background = type === "error" ? "#f88" : "#8f8";
    d.style.padding = "8px 12px";
    d.style.borderRadius = "6px";
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 2500);
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return parts.pop().split(';').shift();
  }
  document.getElementById('user').innerText = getCookie('username') || 'Unknown';

  // Tab switching (calls loadUsers when view-users selected)
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabSections = document.querySelectorAll(".tab-section");

  // Loading overlay helpers
  function showLoading(message = "Processing...") {
    const overlay = document.getElementById("loading-overlay");
    overlay.querySelector(".loading-text").innerText = message;
    overlay.classList.add("show");
  }
  function hideLoading() {
    const overlay = document.getElementById("loading-overlay");
    overlay.classList.remove("show");
  }

  tabButtons.forEach(btn => btn.addEventListener("click", () => {
    const target = btn.dataset.tab;
    tabButtons.forEach(b => b.classList.remove("active")); btn.classList.add("active");
    tabSections.forEach(s => s.style.display = s.id === `tab-${target}` ? "block" : "none");
    if (target === "view-users") loadUsers();
  }));

  // Create user
  document.querySelector(".create-user-form").addEventListener("submit", async e => {
    e.preventDefault();
    const username = document.getElementById("new-username").value.trim();
    const password = document.getElementById("new-password").value;
    const role = document.getElementById("user-role").value;
    if (!username || !password || !role) { showPopup("Please fill in all fields.", "error"); return; }
    showLoading("Creating user...");
    try {
      const res = await fetch("/create-user", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ username, password, role }) });
      const data = await res.json();
      hideLoading();
      if (data.success) { showPopup("User created!", "success"); e.target.reset(); }
      else showPopup("Error: " + data.message, "error");
    } catch (err) { hideLoading(); showPopup("Server error: " + err.message, "error"); }
  });

  // LOAD USERS - use createElement and attach listeners directly
  async function loadUsers() {
    try {
      const res = await fetch("/users");
      const data = await res.json();
      if (!data.success) { showPopup("Unauthorized or failed to load users", "error"); return; }

      const tbody = document.getElementById("users-list");
      tbody.innerHTML = "";

      data.users.forEach(u => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td"); tdName.innerText = u.username;
        const tdRole = document.createElement("td"); tdRole.innerText = u.role;
        const tdActions = document.createElement("td");

        const btnUpdate = document.createElement("button");
        btnUpdate.className = "btn-update";
        btnUpdate.type = "button";
        btnUpdate.dataset.username = u.username;
        btnUpdate.dataset.role = u.role;
        btnUpdate.innerText = "Update";
        btnUpdate.addEventListener("click", showUpdatePopup); // direct attach

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-remove";
        btnDelete.type = "button";
        btnDelete.dataset.username = u.username;
        btnDelete.innerText = "Delete";
        btnDelete.addEventListener("click", deleteUser);

        tdActions.append(btnUpdate, " ", btnDelete);
        tr.append(tdName, tdRole, tdActions);
        tbody.appendChild(tr);
      });
    } catch (err) {
      showPopup("Error loading users: " + err.message, "error");
    }
  }

  // Delete user
  async function deleteUser(e) {
    const username = e.currentTarget.dataset.username;
    if (!confirm(`Delete ${username}?`)) return;
    showLoading("Deleting user...");
    try {
      const res = await fetch("/delete-user", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ username })});
      const data = await res.json();
      hideLoading();
      if (data.success) { showPopup("Deleted", "success"); loadUsers(); }
      else showPopup("Error: " + data.message, "error");
    } catch (err) { hideLoading(); showPopup("Server error: " + err.message, "error"); }
  }

  // Update modal logic
  const updateModal = document.getElementById("update-user-modal");
  const updateForm = document.getElementById("update-user-form");
  const cancelUpdateBtn = document.getElementById("cancel-update");

  function showUpdatePopup(e) {
    // MUST use currentTarget so we always get the element the listener was attached to
    const btn = e.currentTarget;
    const username = (btn && btn.dataset && btn.dataset.username) ? btn.dataset.username : null;
    const role = (btn && btn.dataset && btn.dataset.role) ? btn.dataset.role : 'User';

    if (!username) {
      // extremely defensive: try to read from closest button if click bubbled
      const b = e.target.closest && e.target.closest('button.btn-update');
      if (b) {
        console.warn("fallback read from closest button");
        btn = b;
      }
    }

    // store original username in dataset on the form (source of truth)
    updateForm.dataset.originalUsername = username || '';

    // show it in the readonly input (for user)
    document.getElementById("update-username").value = username || '';

    // set role select
    document.getElementById("update-role").value = role;

    // display modal
    updateModal.style.display = "flex";
    updateModal.setAttribute('aria-hidden', 'false');
  }

  cancelUpdateBtn.addEventListener("click", () => {
    updateModal.style.display = "none";
    updateModal.setAttribute('aria-hidden', 'true');
  });

  // Submit update — IMPORTANT: read username from dataset, NOT the readonly input
  updateForm.addEventListener("submit", async e => {
    e.preventDefault();
    const originalUsername = (updateForm.dataset.originalUsername || '').toString().trim();
    const role = document.getElementById("update-role").value;

    if (!originalUsername || !role) { showPopup("Please fill in all fields.", "error"); return; }

    showLoading("Updating user...");
    try {
      const res = await fetch("/update-user", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ username: originalUsername, role }) });
      const data = await res.json();
      hideLoading();
      if (data.success) {
        showPopup("User updated!", "success");
        updateModal.style.display = "none";
        loadUsers();
      } else {
        // restore display to avoid showing undefined to user
        document.getElementById("update-username").value = originalUsername;
        showPopup("Error: " + data.message, "error");
      }
    } catch (err) {
      hideLoading();
      document.getElementById("update-username").value = originalUsername;
      showPopup("Server error: " + err.message, "error");
    }
  });

  // initial: show schedule tab (do not auto-load users until user clicks the tab)
  // if you want to load immediately uncomment:
  // loadUsers();

</script>
</body>
</html>